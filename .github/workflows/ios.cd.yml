name: CD - Build iOS IPA

on:
  push:
    branches: [ main ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Archive App (no signing)
      run: |
        xcodebuild \
          -scheme "APOD App" \
          -project "APOD App.xcodeproj" \
          -configuration Release \
          -sdk iphoneos \
          archive \
          -archivePath build/AppArchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

- name: Export IPA (no signing)
  run: |
    xcodebuild \
      -exportArchive \
      -archivePath build/AppArchive.xcarchive \
      -exportPath build \
      -exportOptionsPlist .github/workflows/ExportOptions.plist


    - name: Export IPA (no signing)
      run: |
        xcodebuild \
          -exportArchive \
          -archivePath build/AppArchive.xcarchive \
          -exportPath build \
          -exportOptionsPlist .github/workflows/ExportOptions.plist

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-ipa
        path: build/*.ipa
